<!DOCTYPE html>
<html>
<head>
    <style>
        #wrapper{
            display:grid;
            grid-template-areas: "main tools";
        }

        #myCanvas{
            grid-area:main;
        }

        #toolsCanvas{
            grid-area:tools;
        }
        
    </style>
    <script>document.write("<script type='text/javascript' src='tilemap.js?t=" + Date.now() + "'><\/script>");</script>
		<script>

// https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Optimizing_canvas
// https://webrtc.ventures/2022/02/offscreen-canvas-api/
// https://stackoverflow.com/questions/60870336/understanding-offscreen-canvas-to-better-performance
// https://github.com/mozdevs/gamedev-js-tiles/tree/gh-pages?tab=readme-ov-file
// https://developer.mozilla.org/en-US/docs/Games/Techniques/Tilemaps#performance

var c;
var mx,my,mb=0;

var tilesize=51;
var tilecntX=20;
var tilecntY=19;
var tiles = new Image();
var screentiles=16;
var maptiles=66;

var scrollX=0;
var scrollY=0;

var redraw=true;

var keyspressed=[];

// Draw a single tile from tilemap
function drawTile(tileno,dx,dy,tileimg)
{
    var tileX=tileno%tilecntX;
    var tileY=Math.floor(tileno/tilecntX);

    c.drawImage(tileimg, tileX*tilesize, tileY*tilesize, tilesize, tilesize, dx, dy, tilesize, tilesize)
}

function drawtilemap()
{
    // We iterate over screentiles +1 tiles
    var scx=Math.floor((scrollX/tilesize));
    var scy=Math.floor((scrollY/tilesize));
    var offsX=scrollX%tilesize;
    var offsY=scrollY%tilesize;
    for(var i=0;i<(screentiles+1);i++){
        for(var j=0;j<(screentiles+1);j++){
            drawTile(tilemap[((scy+i)*maptiles)+(scx+j)],(j*tilesize)-offsX,(i*tilesize)-offsY,tiles);
        }
    }
}

function keyDownOwn(event)
{
    keyspressed[event.key]=true;

    if(event.key=="ArrowUp"||event.key=="ArrowDown"||event.key=="ArrowLeft"||event.key=="ArrowRight"){
        event.preventDefault();
        return false;
    }
}

function keyUpOwn(event)
{
    keyspressed[event.key]=false;

    if(event.key=="ArrowUp"||event.key=="ArrowDown"||event.key=="ArrowLeft"||event.key=="ArrowRight"){
        event.preventDefault();
        return false;
    }

}

function zetup()
{
    var cc = document.getElementById("myCanvas");
    c = cc.getContext("2d");

    var cc = document.getElementById("toolCanvas");
    toolcanvas = cc.getContext("2d");

    tiles.src = 'tilesets/test.png';
    //drawing of the test image - img1
    tiles.onload = function () {
        updatestate();
    };

    document.addEventListener("keydown", keyDownOwn, false);
    document.addEventListener("keyup", keyUpOwn, false);

var doScroll = function(e) {

    if(event.target.id=="myCanvas"){
        scrollX+=e.deltaX;
        scrollY+=e.deltaY;
        redraw=true;

        e.preventDefault();    
    }

};

if (window.addEventListener) {
  window.addEventListener("wheel", doScroll, { passive: false });
}

    window.requestAnimationFrame(refresh);
}

function refresh()
{
    if(keyspressed["ArrowUp"]){
        scrollY--;
        if(scrollY<0) scrollY=0;
    }
    if(keyspressed["ArrowDown"]){
        scrollY++;
    }
    if(keyspressed["ArrowRight"]){
        scrollX++;
    }
    if(keyspressed["ArrowLeft"]){
        scrollX--;
        if(scrollX<0) scrollX=0;        
    }

    if(keyspressed["ArrowUp"]||keyspressed["ArrowDown"]||keyspressed["ArrowLeft"]||keyspressed["ArrowRight"]){
        redraw=true;
    }
    
    if(redraw){
        drawtilemap();
        redraw=false;
    }
    window.requestAnimationFrame(refresh);
}

function refreshTools()
{
    toolcanvas.drawImage(tiles,0,0,512,512);
    var tooltilesizeX=512/tilecntX;
    var tooltilesizeY=512/tilecntY;
    toolcanvas.globalAlpha=0.4;
    toolcanvas.strokeStyle="#8f8";
    for(var i=0;i<tilecntX;i++){
        toolcanvas.beginPath();
        toolcanvas.moveTo(i*tooltilesizeX,0);
        toolcanvas.lineTo(i*tooltilesizeX,tilecntX*tooltilesizeX);
        toolcanvas.stroke();
    }
    for(var i=0;i<tilecntY;i++){
        toolcanvas.beginPath();
        toolcanvas.moveTo(0,i*tooltilesizeY);
        toolcanvas.lineTo(tilecntY*tooltilesizeY,i*tooltilesizeY);
        toolcanvas.stroke();
    }
}

function updatestate()
{
    drawtilemap();
    refreshTools();
}

function toolup(e)
{

}

function tooldown(e)
{

}

function toolmove(e)
{
  var rect = document.getElementById("toolCanvas").getBoundingClientRect();
  var xk=(e.clientX-rect.left);
  var yk=(e.clientY-rect.top);
}

		</script>
</head>
<body onload="zetup();">

  <div id="wrapper">
 	<canvas id="myCanvas" width="816" height="816" style="border:1px solid #000000;" ></canvas> 
 	<canvas id="toolCanvas" width="1024" height="1024" style="border:1px solid #000000;" onmousedown="tooldown(event);" onmouseup="toolup(event);" onmousemove="toolmove(event);"></canvas> 
  </div>
</body>